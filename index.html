<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ —Ä–µ–±—ë–Ω–∫–∞ (0‚Äì12 –ª–µ—Ç)</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --bd:#e5e7eb; --tx:#111827; --mut:#6b7280;
      --ok:#065f46; --hi:#92400e; --lo:#9f1239; --warn:#374151;
      --btn:#111827; --btnTx:#ffffff;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--tx); }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .top{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:space-between; margin-bottom:14px; }
    h1{ margin:0; font-size:20px; }
    .note{ color:var(--mut); font-size:13px; margin-top:6px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    label{ display:block; font-size:13px; color:var(--mut); margin-bottom:6px; }
    input[type="number"], input[type="text"]{
      padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:white; font-size:14px;
    }
    input.small{ width:140px; }
    input.value{ width:140px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--bd);
      border-radius:999px; background:white; color:var(--mut); font-size:13px;
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:10px 12px; border-radius:12px; border:1px solid var(--bd);
      background:white; cursor:pointer; font-weight:700;
    }
    button.primary{ background:var(--btn); color:var(--btnTx); border-color:var(--btn); }
    button:hover{ filter:brightness(.98); }
    .mut{ color:var(--mut); }
    .hidden{ display:none !important; }
    textarea{
      width:100%; min-height:260px; padding:12px; border:1px solid var(--bd); border-radius:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px; line-height:1.35; resize:vertical;
    }
    .table{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border:1px solid var(--bd); border-radius:14px; background:white;
    }
    .table th, .table td{ padding:10px; border-bottom:1px solid var(--bd); font-size:13px; vertical-align:top; }
    .table th{ text-align:left; color:var(--mut); font-weight:800; background:#fafafa; }
    .table tr:last-child td{ border-bottom:none; }
    .s-ok{ color:var(--ok); font-weight:800; }
    .s-hi{ color:var(--hi); font-weight:800; }
    .s-lo{ color:var(--lo); font-weight:800; }
    .s-warn{ color:var(--warn); font-weight:800; }
    .err{ color:#b91c1c; font-weight:800; margin-top:8px; }
    .mini{ font-size:12px; color:var(--mut); }
    .k{ background:#f3f4f6; padding:2px 6px; border-radius:8px; }
    .divider{ height:1px; background:var(--bd); margin:12px 0; }
    .inputs{
      display:grid;
      grid-template-columns: 1.4fr 140px 140px;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 700px){
      .inputs{ grid-template-columns: 1fr; }
      input.value, input.small{ width:100%; }
    }
    .hdr{
      display:grid;
      grid-template-columns: 1.4fr 140px 140px;
      gap:10px;
      color:var(--mut);
      font-size:12px;
      font-weight:800;
      margin-bottom:8px;
    }
    @media (max-width: 700px){ .hdr{ display:none; } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ —Ä–µ–±—ë–Ω–∫–∞ (0‚Äì12 –ª–µ—Ç)</h1>
      <div class="note">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–±–æ–π –Ω–æ—Ä–º–∞–º–∏. –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞.</div>
    </div>
    <div class="row">
      <div>
        <label for="age">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç, –º–æ–∂–Ω–æ –¥—Ä–æ–±–Ω–æ: 0.5 = 6 –º–µ—Å—è—Ü–µ–≤)</label>
        <input id="age" class="small" type="number" min="0" max="12" step="0.1" value="2" />
      </div>
      <div class="pill" id="agePill">–ì—Ä—É–ø–ø–∞: ‚Äî</div>
    </div>
  </div>

  <div class="grid">
    <!-- –í–≤–æ–¥ -->
    <div class="card">
      <label>–í–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≤–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)</label>
      <div class="mini">–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —É–∂–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã —Å–ø–∏—Å–∫–æ–º. –ù–∏—á–µ–≥–æ ‚Äú–∞–∫—Ç–∏–≤–Ω–æ–≥–æ‚Äù –≤ –ø–æ–ª–µ –Ω–µ—Ç ‚Äî —Ç—ã –ø—Ä–æ—Å—Ç–æ –≤–≤–æ–¥–∏—à—å –∑–Ω–∞—á–µ–Ω–∏—è.</div>
      <div class="divider"></div>

      <div class="hdr">
        <div>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
        <div>–ó–Ω–∞—á–µ–Ω–∏–µ</div>
        <div>–ï–¥.</div>
      </div>

      <div id="inputs" class="inputs"></div>

      <div class="btns">
        <button class="primary" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="fillDemoBtn">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–µ–º–æ</button>
        <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="csvBtn">–°–∫–∞—á–∞—Ç—å CSV</button>
      </div>

      <div class="err" id="error"></div>

      <div class="divider"></div>

      <button id="toggleNormsBtn" type="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º—ã (JSON)</button>
      <div id="normsBox" class="hidden" style="margin-top:10px;">
        <div class="mini">–§–æ—Ä–º–∞—Ç: –ø–æ –≥–æ–¥–∞–º <span class="k">"0"</span>..<span class="k">"12"</span>. –ï—Å–ª–∏ <span class="k">min/max</span> –ø—É—Å—Ç—ã–µ ‚Äî –±—É–¥–µ—Ç ‚Äú–Ω–µ—Ç –Ω–æ—Ä–º—ã‚Äù.</div>
        <textarea id="norms"></textarea>
      </div>
    </div>

    <!-- –û—Ç—á—ë—Ç -->
    <div class="card">
      <label>–û—Ç—á—ë—Ç</label>
      <div id="report" class="mut">–ó–∞–ø–æ–ª–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù.</div>
      <div class="divider"></div>
      <div class="mini">
        ‚ö†Ô∏è –í–∞–∂–Ω–æ: —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –ø–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –∏ –º–µ—Ç–æ–¥–∏–∫–µ. –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö –ª—É—á—à–µ –æ–±—Å—É–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –≤—Ä–∞—á–æ–º.
      </div>
    </div>
  </div>
</div>

<script>
/** ==========================
 *  1) –°–ø–∏—Å–æ–∫ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π (–∫–∞–∫ –≤ —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü–µ)
 *  ========================== */
const INDICATORS = [
  { key: "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (WBC)", unit: "10^9/–ª" },
  { key: "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (RBC)", unit: "10^12/–ª" },
  { key: "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω (HGB)", unit: "–≥/–ª" },
  { key: "–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç (HCT)", unit: "%" },
  { key: "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤ (MCV)", unit: "—Ñ–ª" },
  { key: "–°—Ä–µ–¥–Ω. —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–µ (MCH)", unit: "–ø–≥" },
  { key: "–°—Ä–µ–¥–Ω. –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∞—Ö (MCHC)", unit: "–≥/–ª" },
  { key: "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –≥–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤ (RDW)", unit: "%" },
  { key: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (PLT)", unit: "10^9/–ª" },
  { key: "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º —Ç—Ä–æ–º–±–æ—Ü–∏—Ç–æ–≤ (MPV)", unit: "—Ñ–ª" },

  { key: "–ë–ª–∞—Å—Ç—ã", unit: "%" },
  { key: "–ü—Ä–æ–º–∏–µ–ª–æ—Ü–∏—Ç—ã", unit: "%" },
  { key: "–ü—Ä–æ–ª–∏–º—Ñ–æ—Ü–∏—Ç—ã", unit: "%" },
  { key: "–ú–∏–µ–ª–æ—Ü–∏—Ç—ã", unit: "%" },
  { key: "–ú–µ—Ç–∞–º–∏–µ–ª–æ—Ü–∏—Ç—ã", unit: "%" },

  { key: "–ü–∞–ª–æ—á–∫–æ—è–¥–µ—Ä–Ω—ã–µ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã, %", unit: "%" },
  { key: "–°–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã (NE), %", unit: "%" },
  { key: "–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã (EO), %", unit: "%" },
  { key: "–ë–∞–∑–æ—Ñ–∏–ª—ã (BA), %", unit: "%" },
  { key: "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (LY), %", unit: "%" },
  { key: "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (LY), –∞–±—Å.", unit: "10^9/–ª" },
  { key: "–ú–æ–Ω–æ—Ü–∏—Ç—ã (MO), %", unit: "%" },

  { key: "–ü–ª–∞–∑–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª–µ—Ç–∫–∏", unit: "%" },
  { key: "–°–û–≠", unit: "–º–º/—á" },
];

/** ==========================
 *  2) –ù–æ—Ä–º—ã (—à–∞–±–ª–æ–Ω): min/max –ø—É—Å—Ç—ã–µ, —á—Ç–æ–±—ã —Ç—ã –≤—Å—Ç–∞–≤–∏–ª —Å–≤–æ–∏
 *  –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ø–∏—Ä—É–µ–º –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤ 0..12 –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω.
 *  ========================== */
function makeDefaultNorms(){
  // –ë–∞–∑–æ–≤—ã–µ –Ω–æ—Ä–º—ã (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏/—Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞). –ú–æ–∂–Ω–æ –ø–æ—Ç–æ–º —É—Ç–æ—á–Ω—è—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–º.
  const base = {
    "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (WBC)": { unit:"10^9/–ª", min:5.0, max:12.0 },
    "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (RBC)": { unit:"10^12/–ª", min:3.9, max:5.3 },
    "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω (HGB)": { unit:"–≥/–ª", min:110, max:145 },
    "–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç (HCT)": { unit:"%", min:33, max:42 },

    "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤ (MCV)": { unit:"—Ñ–ª", min:75, max:87 },
    "–°—Ä–µ–¥–Ω. —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–µ (MCH)": { unit:"–ø–≥", min:24, max:30 },
    "–°—Ä–µ–¥–Ω. –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∞—Ö (MCHC)": { unit:"–≥/–ª", min:320, max:360 },
    "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –≥–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤ (RDW)": { unit:"%", min:11.5, max:14.5 },

    "–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (PLT)": { unit:"10^9/–ª", min:150, max:400 },
    "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º —Ç—Ä–æ–º–±–æ—Ü–∏—Ç–æ–≤ (MPV)": { unit:"—Ñ–ª", min:7.0, max:11.0 },

    "–ë–ª–∞—Å—Ç—ã": { unit:"%", min:0, max:0 },
    "–ü—Ä–æ–º–∏–µ–ª–æ—Ü–∏—Ç—ã": { unit:"%", min:0, max:0 },
    "–ü—Ä–æ–ª–∏–º—Ñ–æ—Ü–∏—Ç—ã": { unit:"%", min:0, max:0 },
    "–ú–∏–µ–ª–æ—Ü–∏—Ç—ã": { unit:"%", min:0, max:0 },
    "–ú–µ—Ç–∞–º–∏–µ–ª–æ—Ü–∏—Ç—ã": { unit:"%", min:0, max:0 },

    "–ü–∞–ª–æ—á–∫–æ—è–¥–µ—Ä–Ω—ã–µ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã, %": { unit:"%", min:1, max:6 },
    "–°–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã (NE), %": { unit:"%", min:30, max:55 },
    "–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã (EO), %": { unit:"%", min:0, max:5 },
    "–ë–∞–∑–æ—Ñ–∏–ª—ã (BA), %": { unit:"%", min:0, max:1 },

    "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (LY), %": { unit:"%", min:35, max:60 },
    "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (LY), –∞–±—Å.": { unit:"10^9/–ª", min:1.5, max:7.0 },
    "–ú–æ–Ω–æ—Ü–∏—Ç—ã (MO), %": { unit:"%", min:3, max:10 },

    "–ü–ª–∞–∑–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª–µ—Ç–∫–∏": { unit:"%", min:0, max:0 },
    "–°–û–≠": { unit:"–º–º/—á", min:2, max:10 }
  };

  // –ü–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è: –µ—Å–ª–∏ –≤ INDICATORS –µ—Å—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ base ‚Äî –¥–æ–±–∞–≤–∏–º –ø—É—Å—Ç—ã—à–∫—É
  for (const it of INDICATORS){
    if (!base[it.key]) base[it.key] = { unit: it.unit, min: null, max: null };
  }

  const byYear = {};
  for (let y=0; y<=12; y++){
    byYear[String(y)] = structuredClone(base);
  }
  return byYear;
}

const DEFAULT_NORMS_BY_YEAR = makeDefaultNorms();


/** ==========================
 *  3) UI refs
 *  ========================== */
const els = {
  age: document.getElementById("age"),
  agePill: document.getElementById("agePill"),
  inputs: document.getElementById("inputs"),
  norms: document.getElementById("norms"),
  normsBox: document.getElementById("normsBox"),
  toggleNormsBtn: document.getElementById("toggleNormsBtn"),
  checkBtn: document.getElementById("checkBtn"),
  fillDemoBtn: document.getElementById("fillDemoBtn"),
  clearBtn: document.getElementById("clearBtn"),
  csvBtn: document.getElementById("csvBtn"),
  report: document.getElementById("report"),
  error: document.getElementById("error"),
};

let lastReportRows = [];

/** ==========================
 *  4) Helpers
 *  ========================== */
function clampAge(a){
  if (Number.isNaN(a)) return 0;
  return Math.min(12, Math.max(0, a));
}
function pickYearBand(ageYears){ return Math.floor(clampAge(ageYears)); }
function setBandPill(){
  const age = parseFloat(els.age.value);
  const y = pickYearBand(age);
  els.agePill.textContent = `–ì—Ä—É–ø–ø–∞: ${y} –≥–æ–¥(–ª–µ—Ç)`;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
function compare(value, min, max){
  if (value < min) return "üîª –Ω–∏–∂–µ –Ω–æ—Ä–º—ã";
  if (value > max) return "üî∫ –≤—ã—à–µ –Ω–æ—Ä–º—ã";
  return "‚úÖ –Ω–æ—Ä–º–∞";
}
function statusClass(st){
  if (st.includes("‚úÖ")) return "s-ok";
  if (st.includes("üî∫")) return "s-hi";
  if (st.includes("üîª")) return "s-lo";
  return "s-warn";
}

/** ==========================
 *  5) Build inputs list (–ù–ï textarea ‚Äî –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—è)
 *  ========================== */
function buildInputs(){
  els.inputs.innerHTML = "";
  for (const it of INDICATORS){
    const name = it.key;
    const unit = it.unit;

    const nameEl = document.createElement("div");
    nameEl.innerHTML = `<b>${escapeHtml(name)}</b><div class="mini">${escapeHtml(unit)}</div>`;

    const valueEl = document.createElement("input");
    valueEl.type = "number";
    valueEl.step = "any";
    valueEl.className = "value";
    valueEl.placeholder = "‚Äî";
    valueEl.dataset.key = name;

    const unitEl = document.createElement("input");
    unitEl.type = "text";
    unitEl.className = "small";
    unitEl.value = unit;
    unitEl.dataset.unitFor = name;

    els.inputs.appendChild(nameEl);
    els.inputs.appendChild(valueEl);
    els.inputs.appendChild(unitEl);
  }
}

/** ==========================
 *  6) Read norms JSON
 *  ========================== */
function parseNormsJSON(){
  const txt = els.norms.value.trim();
  return JSON.parse(txt);
}

/** ==========================
 *  7) Collect results from inputs
 *  ========================== */
function collectResults(){
  const rows = [];
  const inputs = els.inputs.querySelectorAll('input.value');
  for (const inp of inputs){
    const key = inp.dataset.key;
    const raw = inp.value;
    if (raw === "" || raw === null) continue;
    const val = Number(String(raw).replace(",", "."));
    const unitInp = els.inputs.querySelector(`input[data-unit-for="${CSS.escape(key)}"]`);
    const unit = unitInp ? unitInp.value.trim() : "";
    rows.push({ name: key, value: val, unit });
  }
  return rows;
}

/** ==========================
 *  8) Render report table
 *  ========================== */
function renderReportTable(rows){
  if (!rows.length){
    els.report.innerHTML = `<div class="mut">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–ø–æ–ª–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù.</div>`;
    return;
  }
  const html = `
    <table class="table">
      <thead>
        <tr>
          <th style="width:34%;">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
          <th style="width:12%;">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
          <th style="width:12%;">–ï–¥.</th>
          <th style="width:22%;">–ù–æ—Ä–º–∞</th>
          <th style="width:20%;">–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td><b>${escapeHtml(r.name)}</b></td>
            <td>${escapeHtml(String(r.value ?? ""))}</td>
            <td>${escapeHtml(r.unit ?? "")}</td>
            <td class="mut">${escapeHtml(r.normText ?? "‚Äî")}</td>
            <td class="${statusClass(r.status)}">${escapeHtml(r.status)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  els.report.innerHTML = html;
}

/** ==========================
 *  9) Main: build report
 *  ========================== */
function buildReport(){
  els.error.textContent = "";
  lastReportRows = [];

  const age = parseFloat(els.age.value);
  const y = pickYearBand(age);

  let normsByYear;
  try{
    normsByYear = parseNormsJSON();
  }catch(e){
    els.error.textContent = "‚ùå –û—à–∏–±–∫–∞ –≤ JSON –Ω–æ—Ä–º. –ü—Ä–æ–≤–µ—Ä—å –∑–∞–ø—è—Ç—ã–µ/–∫–∞–≤—ã—á–∫–∏.";
    renderReportTable([]);
    return;
  }

  const norms = normsByYear[String(y)];
  if (!norms || typeof norms !== "object"){
    els.error.textContent = `‚ùå –ù–µ—Ç –Ω–æ—Ä–º –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞ (–≥–æ–¥): ${y}.`;
    renderReportTable([]);
    return;
  }

  const results = collectResults();
  if (!results.length){
    els.error.textContent = "‚ùå –¢—ã –Ω–µ –≤–≤—ë–ª –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.";
    renderReportTable([]);
    return;
  }

  const rows = [];
  for (const r of results){
    const n = norms[r.name];
    if (!n){
      rows.push({ name:r.name, value:r.value, unit:r.unit, normText:"‚Äî", status:"‚ö†Ô∏è –Ω–µ—Ç –Ω–æ—Ä–º—ã" });
      continue;
    }

    // –ï—Å–ª–∏ min/max –Ω–µ –∑–∞–¥–∞–Ω—ã ‚Äî –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
    const min = (n.min === null || n.min === "" || typeof n.min === "undefined") ? NaN : Number(n.min);
    const max = (n.max === null || n.max === "" || typeof n.max === "undefined") ? NaN : Number(n.max);

    if (!Number.isFinite(min) || !Number.isFinite(max)){
      rows.push({
        name:r.name, value:r.value, unit:r.unit,
        normText:"‚Äî",
        status:"‚ö†Ô∏è –Ω–æ—Ä–º–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞"
      });
      continue;
    }

    // –ï–¥–∏–Ω–∏—Ü—ã: –µ—Å–ª–∏ —Ä–∞–∑–Ω—ã–µ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    const nu = String(n.unit ?? "").trim();
    const ru = String(r.unit ?? "").trim();
    if (nu && ru && nu !== ru){
      rows.push({
        name:r.name, value:r.value, unit:r.unit,
        normText:`${min}‚Äì${max} ${nu}`,
        status:"‚ö†Ô∏è —Ä–∞–∑–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã"
      });
      continue;
    }

    const st = compare(Number(r.value), min, max);
    rows.push({
      name:r.name,
      value:Number(r.value),
      unit: ru || nu,
      normText:`${min}‚Äì${max} ${ru || nu}`.trim(),
      status: st
    });
  }

  lastReportRows = rows;
  renderReportTable(rows);
}

/** ==========================
 *  10) CSV
 *  ========================== */
function downloadCSV(){
  if (!lastReportRows.length){
    els.error.textContent = "‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª—Å—è –æ—Ç—á—ë—Ç.";
    return;
  }
  const header = ["–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å","–ó–Ω–∞—á–µ–Ω–∏–µ","–ï–¥.","–ù–æ—Ä–º–∞","–°—Ç–∞—Ç—É—Å"];
  const lines = [header.join(";")].concat(
    lastReportRows.map(r => [
      r.name, r.value ?? "", r.unit ?? "", r.normText ?? "", r.status ?? ""
    ].map(x => String(x).replaceAll(";", ",")).join(";"))
  );
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "labs_report.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** ==========================
 *  11) Demo fill
 *  ========================== */
function fillDemo(){
  const demo = {
    "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (WBC)": 6.1,
    "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (RBC)": 4.6,
    "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω (HGB)": 112,
    "–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç (HCT)": 34,
    "–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (PLT)": 420,
    "–ì–ª—é–∫–æ–∑–∞": 5.2
  };
  // –ó–∞–ø–æ–ª–Ω–∏–º —Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, —á—Ç–æ –µ—Å—Ç—å
  const inputs = els.inputs.querySelectorAll('input.value');
  for (const inp of inputs){
    const key = inp.dataset.key;
    inp.value = (demo[key] ?? "");
  }
}

/** ==========================
 *  12) Clear
 *  ========================== */
function clearAll(){
  els.error.textContent = "";
  const inputs = els.inputs.querySelectorAll('input.value');
  for (const inp of inputs) inp.value = "";
  renderReportTable([]);
}

/** ==========================
 *  13) Init
 *  ========================== */
buildInputs();
els.norms.value = JSON.stringify(DEFAULT_NORMS_BY_YEAR, null, 2);
setBandPill();
renderReportTable([]);

els.age.addEventListener("input", setBandPill);
els.checkBtn.addEventListener("click", buildReport);
els.csvBtn.addEventListener("click", downloadCSV);
els.fillDemoBtn.addEventListener("click", () => { fillDemo(); els.error.textContent=""; });
els.clearBtn.addEventListener("click", clearAll);

els.toggleNormsBtn.addEventListener("click", () => {
  const hidden = els.normsBox.classList.contains("hidden");
  els.normsBox.classList.toggle("hidden");
  els.toggleNormsBtn.textContent = hidden ? "–°–∫—Ä—ã—Ç—å –Ω–æ—Ä–º—ã (JSON)" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º—ã (JSON)";
});
</script>
</body>
</html>
