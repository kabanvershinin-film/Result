<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --bd:#e5e7eb; --tx:#111827; --mut:#6b7280;
      --ok:#065f46; --hi:#92400e; --lo:#9f1239; --warn:#374151;
      --btn:#111827; --btnTx:#ffffff;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--tx); }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .top{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:space-between; margin-bottom:14px; }
    h1{ margin:0; font-size:20px; }
    .note{ color:var(--mut); font-size:13px; margin-top:6px; }
    .row{ display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    label{ display:block; font-size:13px; color:var(--mut); margin-bottom:6px; }
    input[type="number"], input[type="text"], select{
      padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:white; font-size:14px;
    }
    input.small{ width:140px; }
    input.value{ width:160px; }
    select.small{ width:220px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--bd);
      border-radius:999px; background:white; color:var(--mut); font-size:13px;
    }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{
      padding:10px 12px; border-radius:12px; border:1px solid var(--bd);
      background:white; cursor:pointer; font-weight:700;
    }
    button.primary{ background:var(--btn); color:var(--btnTx); border-color:var(--btn); }
    button:hover{ filter:brightness(.98); }
    .mut{ color:var(--mut); }
    .hidden{ display:none !important; }
    textarea{
      width:100%; min-height:260px; padding:12px; border:1px solid var(--bd); border-radius:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12.5px; line-height:1.35; resize:vertical;
    }
    .table{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border:1px solid var(--bd); border-radius:14px; background:white;
    }
    .table th, .table td{ padding:10px; border-bottom:1px solid var(--bd); font-size:13px; vertical-align:top; }
    .table th{ text-align:left; color:var(--mut); font-weight:800; background:#fafafa; }
    .table tr:last-child td{ border-bottom:none; }
    .s-ok{ color:var(--ok); font-weight:800; }
    .s-hi{ color:var(--hi); font-weight:800; }
    .s-lo{ color:var(--lo); font-weight:800; }
    .s-warn{ color:var(--warn); font-weight:800; }
    .err{ color:#b91c1c; font-weight:800; margin-top:8px; }
    .mini{ font-size:12px; color:var(--mut); }
    .k{ background:#f3f4f6; padding:2px 6px; border-radius:8px; }
    .divider{ height:1px; background:var(--bd); margin:12px 0; }

    .inputs{
      display:grid;
      grid-template-columns: 1.4fr 160px 140px;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 700px){
      .inputs{ grid-template-columns: 1fr; }
      input.value, input.small, select{ width:100%; }
    }
    .hdr{
      display:grid;
      grid-template-columns: 1.4fr 160px 140px;
      gap:10px;
      color:var(--mut);
      font-size:12px;
      font-weight:800;
      margin-bottom:8px;
    }
    @media (max-width: 700px){ .hdr{ display:none; } }

    details summary{
      cursor:pointer;
      user-select:none;
      color:#111827;
      font-weight:800;
    }
    details .mini{ margin-top:6px; }
    .tag{
      display:inline-flex;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--bd);
      font-size:12px;
      font-weight:800;
      background:#fff;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤</h1>
      <div class="note">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–∞–º–∏. –ù–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –¥–∏–∞–≥–Ω–æ–∑.</div>
    </div>

    <div class="row">
      <div>
        <label for="analysisType">–ß—Ç–æ –æ—Ü–µ–Ω–∏–≤–∞–µ–º</label>
        <select id="analysisType" class="small">
          <option value="blood">–ö—Ä–æ–≤—å (–û–ê–ö)</option>
          <option value="coprogram">–ö–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞</option>
        </select>
      </div>

      <div id="ageBox">
        <label for="age">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç, –º–æ–∂–Ω–æ –¥—Ä–æ–±–Ω–æ: 0.5 = 6 –º–µ—Å—è—Ü–µ–≤)</label>
        <input id="age" class="small" type="number" min="0" max="18" step="0.1" value="6" />
      </div>

      <div class="pill" id="agePill">–ì—Ä—É–ø–ø–∞: ‚Äî</div>

      <div>
        <label for="preset">–ì–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
        <select id="preset" class="small">
          <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- –í–≤–æ–¥ -->
    <div class="card">
      <label id="inputTitle">–í–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</label>
      <div class="mini" id="inputHint">–í–ø–∏—à–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù.</div>
      <div class="divider"></div>

      <div class="hdr" id="hdrRow">
        <div>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
        <div>–ó–Ω–∞—á–µ–Ω–∏–µ</div>
        <div>–ï–¥.</div>
      </div>

      <div id="inputs" class="inputs"></div>

      <div class="btns">
        <button class="primary" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="fillDemoBtn">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
        <button id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="csvBtn">–°–∫–∞—á–∞—Ç—å CSV</button>
      </div>

      <div class="err" id="error"></div>

      <div id="normsEditorBlock" class="hidden">
        <div class="divider"></div>
        <button id="toggleNormsBtn" type="button">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º—ã (JSON)</button>
        <div id="normsBox" class="hidden" style="margin-top:10px;">
          <div class="mini">–ï—Å–ª–∏ <span class="k">min/max</span> –ø—É—Å—Ç—ã–µ ‚Äî ‚Äú–Ω–µ—Ç –Ω–æ—Ä–º—ã‚Äù.</div>
          <textarea id="norms"></textarea>
        </div>
      </div>
    </div>

    <!-- –û—Ç—á—ë—Ç -->
    <div class="card">
      <label>–û—Ç—á—ë—Ç</label>
      <div id="report" class="mut">–ó–∞–ø–æ–ª–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù.</div>
      <div class="divider"></div>
      <div class="mini">
        ‚ö†Ô∏è –í–∞–∂–Ω–æ: —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –ø–æ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ –∏ –º–µ—Ç–æ–¥–∏–∫–µ. –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö –ª—É—á—à–µ –æ–±—Å—É–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –≤—Ä–∞—á–æ–º.
      </div>
    </div>
  </div>
</div>

<script>
/** =========================================================
 *  1) –ö–†–û–í–¨ ‚Äî –æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ–π —Å–ø–∏—Å–æ–∫ (–∫–∞–∫ –±—ã–ª)
 *  ========================================================= */
const BLOOD_INDICATORS = [
  { key: "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (WBC)", unit: "10^9/–ª" },
  { key: "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (RBC)", unit: "10^12/–ª" },
  { key: "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω (HGB)", unit: "–≥/–ª" },
  { key: "–ì–µ–º–∞—Ç–æ–∫—Ä–∏—Ç (HCT)", unit: "%" },
  { key: "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤ (MCV)", unit: "—Ñ–ª" },
  { key: "–°—Ä–µ–¥–Ω. —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–µ (MCH)", unit: "–ø–≥" },
  { key: "–°—Ä–µ–¥–Ω. –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ –≤ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–∞—Ö (MCHC)", unit: "–≥/–ª" },
  { key: "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –≥–µ—Ç–µ—Ä–æ–≥–µ–Ω–Ω–æ—Å—Ç–∏ —ç—Ä–∏—Ç—Ä–æ—Ü–∏—Ç–æ–≤ (RDW)", unit: "%" },
  { key: "–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (PLT)", unit: "10^9/–ª" },
  { key: "–°—Ä–µ–¥–Ω–∏–π –æ–±—ä—ë–º —Ç—Ä–æ–º–±–æ—Ü–∏—Ç–æ–≤ (MPV)", unit: "—Ñ–ª" },

  { key: "–ë–ª–∞—Å—Ç—ã", unit: "%" },
  { key: "–ü—Ä–æ–º–∏–µ–ª–æ—Ü–∏—Ç—ã", unit: "%" },
  { key: "–ü—Ä–æ–ª–∏–º—Ñ–æ—Ü–∏—Ç—ã", unit: "%" },
  { key: "–ú–∏–µ–ª–æ—Ü–∏—Ç—ã", unit: "%" },
  { key: "–ú–µ—Ç–∞–º–∏–µ–ª–æ—Ü–∏—Ç—ã", unit: "%" },

  { key: "–ü–∞–ª–æ—á–∫–æ—è–¥–µ—Ä–Ω—ã–µ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã, %", unit: "%" },
  { key: "–°–µ–≥–º–µ–Ω—Ç–æ—è–¥–µ—Ä–Ω—ã–µ –Ω–µ–π—Ç—Ä–æ—Ñ–∏–ª—ã (NE), %", unit: "%" },
  { key: "–≠–æ–∑–∏–Ω–æ—Ñ–∏–ª—ã (EO), %", unit: "%" },
  { key: "–ë–∞–∑–æ—Ñ–∏–ª—ã (BA), %", unit: "%" },
  { key: "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (LY), %", unit: "%" },
  { key: "–õ–∏–º—Ñ–æ—Ü–∏—Ç—ã (LY), –∞–±—Å.", unit: "10^9/–ª" },
  { key: "–ú–æ–Ω–æ—Ü–∏—Ç—ã (MO), %", unit: "%" },

  { key: "–ü–ª–∞–∑–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª–µ—Ç–∫–∏", unit: "%" },
  { key: "–°–û–≠", unit: "–º–º/—á" },
];

function makeBlankBloodNorms(){
  const yearObj = {};
  for (const it of BLOOD_INDICATORS){
    yearObj[it.key] = { unit: it.unit, min: null, max: null };
  }
  const byYear = {};
  for (let y=0; y<=18; y++){
    byYear[String(y)] = structuredClone(yearObj);
  }
  return byYear;
}
const DEFAULT_BLOOD_NORMS_BY_YEAR = makeBlankBloodNorms();

/** =========================================================
 *  2) –ö–û–ü–†–û–ì–†–ê–ú–ú–ê ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ —Ç–≤–æ–∏–º —Ñ–æ—Ç–æ
 *  ========================================================= */
const COPROGRAM_FIELDS = [
  { key:"–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è", type:"select", unit:"", options:[
    {v:"–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π", t:"–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π, —Ü–∏–ª–∏–Ω–¥—Ä–∏—á–µ—Å–∫–∏–π (–ù–æ—Ä–º–∞)"},
    {v:"–∫–∞—à–µ–æ–±—Ä–∞–∑–Ω—ã–π", t:"–ö–∞—à–∏—Ü–µ–æ–±—Ä–∞–∑–Ω—ã–π"},
    {v:"–∂–∏–¥–∫–∏–π", t:"–ñ–∏–¥–∫–∏–π/–∫–∞—à–∏—Ü–µ–æ–±—Ä–∞–∑–Ω—ã–π (–¥–∏–∞—Ä–µ—è)"},
    {v:"—Ç–≤–µ—Ä–¥—ã–π", t:"–¢–≤—ë—Ä–¥—ã–π"},
  ]},
  { key:"–§–æ—Ä–º–∞ –ø–æ –ë—Ä–∏—Å—Ç–æ–ª—å—Å–∫–æ–π —à–∫–∞–ª–µ", type:"select", unit:"", options:[
    {v:"1", t:"–¢–∏–ø 1 ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–≤—ë—Ä–¥—ã–µ –∫–æ–º–∫–∏ (–∑–∞–ø–æ—Ä)"},
    {v:"2", t:"–¢–∏–ø 2 ‚Äî –∫–æ–ª–±–∞—Å–∫–∞ –∫–æ–º–∫–æ–≤–∞—Ç–∞—è (—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –∑–∞–ø–æ—Ä—É)"},
    {v:"3", t:"–¢–∏–ø 3 ‚Äî –∫–æ–ª–±–∞—Å–∫–∞ —Å —Ç—Ä–µ—â–∏–Ω–∞–º–∏ (–Ω–æ—Ä–º–∞)"},
    {v:"4", t:"–¢–∏–ø 4 ‚Äî –≥–ª–∞–¥–∫–∞—è –∫–æ–ª–±–∞—Å–∫–∞/–∑–º–µ–π–∫–∞ (–Ω–æ—Ä–º–∞)"},
    {v:"5", t:"–¢–∏–ø 5 ‚Äî –º—è–≥–∫–∏–µ —à–∞—Ä–∏–∫–∏ (—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –¥–∏–∞—Ä–µ–µ)"},
    {v:"6", t:"–¢–∏–ø 6 ‚Äî –∫–∞—à–∏—Ü–µ–æ–±—Ä–∞–∑–Ω—ã–π —Å –Ω–µ—Ä–æ–≤–Ω—ã–º–∏ –∫—Ä–∞—è–º–∏ (–¥–∏–∞—Ä–µ—è)"},
    {v:"7", t:"–¢–∏–ø 7 ‚Äî –≤–æ–¥—è–Ω–∏—Å—Ç—ã–π (—Å–∏–ª—å–Ω–∞—è –¥–∏–∞—Ä–µ—è)"},
  ]},
  { key:"–ó–∞–ø–∞—Ö", type:"select", unit:"", options:[
    {v:"–∫–∞–ª–æ–≤–∏–π", t:"–ö–∞–ª–æ–≤—ã–π, –Ω–µ—Ä–µ–∑–∫–∏–π (–ù–æ—Ä–º–∞)"},
    {v:"–∑–ª–æ–≤–æ–Ω–Ω—ã–π", t:"–ó–ª–æ–≤–æ–Ω–Ω—ã–π"},
    {v:"–∫–∏—Å–ª—ã–π", t:"–ö–∏—Å–ª—ã–π"},
  ]},
  { key:"–¶–≤–µ—Ç", type:"select", unit:"", options:[
    {v:"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π", t:"–°–≤–µ—Ç–ª–æ-/—Ç—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π (–ù–æ—Ä–º–∞)"},
    {v:"—Ç–µ–º–Ω—ã–π", t:"–û—á–µ–Ω—å —Ç—ë–º–Ω—ã–π"},
    {v:"—Å–≤–µ—Ç–ª—ã–π", t:"–°–≤–µ—Ç–ª—ã–π"},
    {v:"–±–µ—Å—Ü–≤–µ—Ç–Ω—ã–π", t:"–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–≤–µ—Ç–∞"},
    {v:"–∫—Ä–∞—Å–Ω—ã–π", t:"–ö—Ä–∞—Å–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫"},
    {v:"—á–µ—Ä–Ω—ã–π", t:"–ß—ë—Ä–Ω—ã–π"},
  ]},
  { key:"–†–µ–∞–∫—Ü–∏—è pH", type:"number", unit:"pH", placeholder:"–Ω–∞–ø—Ä–∏–º–µ—Ä 6.8" },
  { key:"–°–ª–∏–∑—å", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–ù–µ—Ç (–ù–æ—Ä–º–∞)"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},

  { key:"–ñ–∏—Ä –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"},
    {v:"–º–∞–ª–æ", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç / –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—É –¥–µ—Ç–µ–π)"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å (–º–Ω–æ–≥–æ)"},
  ]},
  { key:"–ñ–∏—Ä–Ω—ã–µ –∫–∏—Å–ª–æ—Ç—ã", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç / –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–ú—ã–ª–∞", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç / –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},

  { key:"–ü–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–ù–µ–ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞", type:"select", unit:"", options:[
    {v:"–µ—Å—Ç—å", t:"–í –Ω–æ—Ä–º–µ ‚Äî –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ"},
    {v:"–Ω–µ—Ç", t:"–ù–µ—Ç (–ø–æ—á—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)"},
  ]},
  { key:"–í–Ω—É—Ç—Ä–∏–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–í–Ω–µ–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞—Å—â–µ–ø–ª—è–µ—Ç—Å—è (–Ω–µ—Ç)"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},

  { key:"–î—Ä–æ–∂–∂–µ–ø–æ–¥–æ–±–Ω—ã–µ –≥—Ä–∏–±—ã", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–ù–µ—Ç (–Ω–æ—Ä–º–∞/–Ω–µ –æ–ø–∏—Å–∞–Ω–æ –∫–∞–∫ –Ω–æ—Ä–º–∞ ‚Äî –æ—Ä–∏–µ–Ω—Ç–∏—Ä)"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–õ–µ–π–∫–æ—Ü–∏—Ç—ã (–∫–∞–ª)", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–ù–æ—Ä–º–∞ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"},
    {v:"–µ–¥–∏–Ω–∏—á–Ω—ã–µ", t:"–î–æ –≥–æ–¥–∞ ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ –µ–¥–∏–Ω–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å (–º–Ω–æ–≥–æ)"},
  ]},
  { key:"–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (–∫–∞–ª)", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–≠–ø–∏—Ç–µ–ª–∏–π", type:"select", unit:"", options:[
    {v:"–Ω–µ–º–Ω–æ–≥–æ", t:"–í –Ω–æ—Ä–º–µ ‚Äî –Ω–µ–±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"},
    {v:"–º–Ω–æ–≥–æ", t:"–ú–Ω–æ–≥–æ"},
  ]},
  { key:"–ö–ª–æ—Å—Ç—Ä–∏–¥–∏–∏", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–ô–æ–¥–æ—Ñ–∏–ª—å–Ω–∞—è —Ñ–ª–æ—Ä–∞", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"},
    {v:"–µ—Å—Ç—å", t:"–ï—Å—Ç—å"},
  ]},
  { key:"–ö—Ä–∏—Å—Ç–∞–ª–ª—ã", type:"select", unit:"", options:[
    {v:"–Ω–µ—Ç", t:"–í –Ω–æ—Ä–º–µ ‚Äî –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"},
    {v:"—Ç—Ä–∏–ø–µ–ª—å—Ñ–æ—Å—Ñ–∞—Ç—ã", t:"–¢—Ä–∏–ø–µ–ª—å—Ñ–æ—Å—Ñ–∞—Ç—ã"},
    {v:"–¥—Ä—É–≥–æ–µ", t:"–î—Ä—É–≥–∏–µ"},
  ]},
];

/** –ù–æ—Ä–º—ã –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –ø–æ –∫–æ–ø—Ä–æ–≥—Ä–∞–º–º–µ (–∏–∑ —Ç–≤–æ–∏—Ö —Ñ–æ—Ç–æ) */
const COPROGRAM_RULES = {
  "–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è": {
    norm: ["–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π"],
    explain: {
      "–∫–∞—à–µ–æ–±—Ä–∞–∑–Ω—ã–π": "–ß–∞—Å—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –±–æ–ª—å—à–∏–º –æ–±—ä—ë–º–æ–º —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–π –ø–∏—â–∏/–∫–ª–µ—Ç—á–∞—Ç–∫–∏ (—É—Å–∏–ª–µ–Ω–∏–µ –ø–µ—Ä–∏—Å—Ç–∞–ª—å—Ç–∏–∫–∏).",
      "–∂–∏–¥–∫–∏–π": "–ú–æ–∂–µ—Ç –±—ã—Ç—å –¥–∏–∞—Ä–µ–µ–π: –º–Ω–æ–≥–æ –≤–æ–¥—ã (–¥–æ 85% –∏ –±–æ–ª–µ–µ), —É—á–∞—â–µ–Ω–∏–µ —Å—Ç—É–ª–∞.",
      "—Ç–≤–µ—Ä–¥—ã–π": "–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è (–∑–∞–ø–æ—Ä), –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–ª–∞ (–≤–æ–¥–∞ < 50‚Äì60%)."
    }
  },
  "–§–æ—Ä–º–∞ –ø–æ –ë—Ä–∏—Å—Ç–æ–ª—å—Å–∫–æ–π —à–∫–∞–ª–µ": {
    norm: ["3","4"],
    explain: {
      "1":"–ó–∞–ø–æ—Ä.",
      "2":"–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –∑–∞–ø–æ—Ä—É.",
      "5":"–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –¥–∏–∞—Ä–µ–µ.",
      "6":"–î–∏–∞—Ä–µ—è.",
      "7":"–°–∏–ª—å–Ω–∞—è –¥–∏–∞—Ä–µ—è."
    }
  },
  "–ó–∞–ø–∞—Ö": {
    norm: ["–∫–∞–ª–æ–≤–∏–π"],
    explain: {
      "–∑–ª–æ–≤–æ–Ω–Ω—ã–π":"–ì–æ–≤–æ—Ä–∏—Ç –æ –≥–Ω–∏–ª–æ—Å—Ç–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ.",
      "–∫–∏—Å–ª—ã–π":"–£—Å–∏–ª–µ–Ω–∏–µ –±—Ä–æ–∂–µ–Ω–∏—è –ø–∏—â–∏ / –∏–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å / —Å–±–æ–π —Ñ–µ—Ä–º–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (—É–≥–ª–µ–≤–æ–¥—ã)."
    }
  },
  "–¶–≤–µ—Ç": {
    norm: ["–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π","—Ç–µ–º–Ω—ã–π","—Å–≤–µ—Ç–ª—ã–π"], // —Ç–µ–º–Ω—ã–π/—Å–≤–µ—Ç–ª—ã–π –¥–æ–ø—É—Å—Ç–∏–º—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é, –Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ—è—Å–Ω—è–µ–º
    warn: ["—Ç–µ–º–Ω—ã–π","—Å–≤–µ—Ç–ª—ã–π"],
    explain: {
      "—Ç–µ–º–Ω—ã–π":"–ß–∞—â–µ ‚Äî —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º—è—Å–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.",
      "—Å–≤–µ—Ç–ª—ã–π":"–ß–∞—â–µ ‚Äî –º–æ–ª–æ—á–Ω–æ-—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ.",
      "–±–µ—Å—Ü–≤–µ—Ç–Ω—ã–π":"–ü—Ä–∏–∑–Ω–∞–∫ –∑–∞–∫—É–ø–æ—Ä–∫–∏ –∂–µ–ª—á–µ–≤—ã–≤–æ–¥—è—â–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–≤ –∏–ª–∏ —Å–±–æ—è –≤ —Ä–∞–±–æ—Ç–µ –ø–µ—á–µ–Ω–∏.",
      "–∫—Ä–∞—Å–Ω—ã–π":"–ü—Ä–∏–∑–Ω–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è –Ω–∏–∂–Ω–∏—Ö –æ—Ç–¥–µ–ª–æ–≤ –ñ–ö–¢.",
      "—á–µ—Ä–Ω—ã–π":"–ü—Ä–∏–∑–Ω–∞–∫ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è –∏–∑ –≤–µ—Ä—Ö–Ω–∏—Ö –æ—Ç–¥–µ–ª–æ–≤ –ñ–ö–¢ (–æ–∫–∏—Å–ª–µ–Ω–∏–µ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω–∞ —Å–æ–ª—è–Ω–æ–π –∫–∏—Å–ª–æ—Ç–æ–π)."
    }
  },
  "–†–µ–∞–∫—Ü–∏—è pH": {
    // –ø–æ —Ñ–æ—Ç–æ:
    // –ì–í: 4.8‚Äì5.8 ; –ò–í: 6.8‚Äì7.0 ; —Å—Ç–∞—Ä—à–µ –≥–æ–¥–∞: 6‚Äì8
    byAge: [
      { label:"0‚Äì1 –≥–æ–¥ (–ì–í)", min:4.8, max:5.8 },
      { label:"0‚Äì1 –≥–æ–¥ (–ò–í)", min:6.8, max:7.0 },
      { label:"—Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞", min:6.0, max:8.0 },
    ],
    explainLow: "–°–¥–≤–∏–≥ –≤ –∫–∏—Å–ª—É—é —Å—Ç–æ—Ä–æ–Ω—É: –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—è –±–∞–∫—Ç–µ—Ä–∏–π/–±—Ä–æ–∂–µ–Ω–∏–µ.",
    explainHigh: "–°–¥–≤–∏–≥ –≤ —â–µ–ª–æ—á–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É: —á–∞—Å—Ç–æ –ø—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ —Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏—è –±–µ–ª–∫–æ–≤, –¥–∏—Å–±–∏–æ–∑–µ, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –∞–º–º–∏–∞–∫–∞."
  },
  "–°–ª–∏–∑—å": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ü–æ—è–≤–ª—è–µ—Ç—Å—è —Å–ª–∏–∑—å ‚Äî –ø—Ä–∏ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ."}
  },
  "–ñ–∏—Ä –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π": {
    norm:["–Ω–µ—Ç","–º–∞–ª–æ"],
    explain:{ "–µ—Å—Ç—å":"–ù–∞—Ä—É—à–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–∂–µ–ª—É–¥–æ—á–Ω–æ–π/–∂–µ–ª—á–Ω–æ–≥–æ –ø—É–∑—ã—Ä—è; –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏—è –∏ —É—Å–≤–æ–µ–Ω–∏—è –∂–∏—Ä–æ–≤."}
  },
  "–ñ–∏—Ä–Ω—ã–µ –∫–∏—Å–ª–æ—Ç—ã": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ü—Ä–æ–¥—É–∫—Ç —Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏—è –∂–∏—Ä–æ–≤; –Ω–∞–ª–∏—á–∏–µ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –Ω–∞—Ä—É—à–µ–Ω–∏–π —É—Å–≤–æ–µ–Ω–∏—è/—Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏—è –∂–∏—Ä–æ–≤."}
  },
  "–ú—ã–ª–∞": {
    norm:["–Ω–µ—Ç","–º–∞–ª–æ"],
    explain:{ "–µ—Å—Ç—å":"–í–∏–¥–æ–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –∂–∏—Ä–æ–≤. –ù–∞–ª–∏—á–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º —É—Å–≤–æ–µ–Ω–∏—è/—Ä–∞—Å—â–µ–ø–ª–µ–Ω–∏—è –∂–∏—Ä–æ–≤."}
  },
  "–ü–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å–æ–ª—è–Ω–æ–π –∫–∏—Å–ª–æ—Ç—ã, —É—Å–∏–ª–µ–Ω–∏–µ –≥–Ω–∏–ª–æ—Å—Ç–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è."}
  },
  "–ù–µ–ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞": {
    norm:["–µ—Å—Ç—å"],
    explain:{ "–Ω–µ—Ç":"–ï—Å–ª–∏ –ø–æ—á—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ –±–µ–¥–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω –ø–æ –∫–ª–µ—Ç—á–∞—Ç–∫–µ/–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∏—Ç–∞–Ω–∏—è."}
  },
  "–í–Ω—É—Ç—Ä–∏–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —Å–µ–∫—Ä–µ—Ü–∏–∏ –∂–µ–ª—É–¥–æ—á–Ω–æ–≥–æ —Å–æ–∫–∞/—É—Å–∏–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–Ω–∏—è –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ."}
  },
  "–í–Ω–µ–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–µ—Ä–º–µ–Ω—Ç–æ–≤ (–∞–º–∏–ª–∞–∑–∞) –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –ø–∏—â–∏ –ø–æ –∫–∏—à–µ—á–Ω–∏–∫—É."}
  },
  "–î—Ä–æ–∂–∂–µ–ø–æ–¥–æ–±–Ω—ã–µ –≥—Ä–∏–±—ã": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏ —Å–Ω–∏–∂–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ñ–ª–æ—Ä—ã (–ø–æ—Å–ª–µ –∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫–æ–≤), –∏–∑–±—ã—Ç–∫–µ —Å–ª–∞–¥–∫–æ–≥–æ/—É–≥–ª–µ–≤–æ–¥–æ–≤, —Å–Ω–∏–∂–µ–Ω–∏–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞, –ø–∞—Ä–∞–∑–∏—Ç–∞—Ä–Ω–æ–π –∏–Ω–≤–∞–∑–∏–∏."}
  },
  "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (–∫–∞–ª)": {
    norm:["–Ω–µ—Ç"],
    explain:{
      "–µ–¥–∏–Ω–∏—á–Ω—ã–µ":"–î–æ –≥–æ–¥–∞ ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ –µ–¥–∏–Ω–∏—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.",
      "–µ—Å—Ç—å":"–ü—Ä–∏–∑–Ω–∞–∫ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ/–∏–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –ø–∏—â–µ–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ."
    }
  },
  "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (–∫–∞–ª)": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–æ–≤ –ñ–ö–¢ (—ç—Ä–æ–∑–∏–∏, —è–∑–≤—ã, —Ç—Ä–µ—â–∏–Ω—ã —Å–ª–∏–∑–∏—Å—Ç–æ–π), –∞–ª–ª–µ—Ä–≥–∏–∏."}
  },
  "–≠–ø–∏—Ç–µ–ª–∏–π": {
    norm:["–Ω–µ–º–Ω–æ–≥–æ"],
    explain:{ "–º–Ω–æ–≥–æ":"–ë–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –∫–∏—à–µ—á–Ω–æ–π —Å—Ç–µ–Ω–∫–µ."}
  },
  "–ö–ª–æ—Å—Ç—Ä–∏–¥–∏–∏": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ù–∞–ª–∏—á–∏–µ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –≥–Ω–∏–µ–Ω–∏—è –≤ –∫–∏—à–µ—á–Ω–∏–∫–µ (—É—Å–∏–ª–µ–Ω–∏–µ –≥–Ω–∏–µ–Ω–∏—è –±–µ–ª–∫–æ–≤ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π —Ñ–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏–∏)." }
  },
  "–ô–æ–¥–æ—Ñ–∏–ª—å–Ω–∞—è —Ñ–ª–æ—Ä–∞": {
    norm:["–Ω–µ—Ç"],
    explain:{ "–µ—Å—Ç—å":"–ß–∞—Å—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –±—Ä–æ–¥–∏–ª—å–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏/–¥–∏—Å–±–∏–æ–∑–æ–º (–≤ —Ç–≤–æ—ë–º –ª–∏—Å—Ç–µ —ç—Ç–æ –±–ª–æ–∫ ¬´–π–æ–¥–æ—Ñ–∏–ª—å–Ω–∞—è —Ñ–ª–æ—Ä–∞¬ª)." }
  },
  "–ö—Ä–∏—Å—Ç–∞–ª–ª—ã": {
    norm:["–Ω–µ—Ç"],
    explain:{
      "—Ç—Ä–∏–ø–µ–ª—å—Ñ–æ—Å—Ñ–∞—Ç—ã":"–û–±—Ä–∞–∑—É—é—Ç—Å—è –≤ —Ä–µ–∑–∫–æ —â–µ–ª–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≥–Ω–∏–ª–æ—Å—Ç–Ω—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π). –ï—Å–ª–∏ —Å–æ—á–µ—Ç–∞—é—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ç–æ–ª–æ–≥–∏—è–º–∏ ‚Äî –Ω—É–∂–Ω–æ –∫ –≤—Ä–∞—á—É.",
      "–¥—Ä—É–≥–æ–µ":"–ö—Ä–∏—Å—Ç–∞–ª–ª—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–∞—Ç–æ–ª–æ–≥–∏–∏ (–≤ –Ω–æ—Ä–º–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)."
    }
  },
};

/** =========================================================
 *  3) UI refs
 *  ========================================================= */
const els = {
  analysisType: document.getElementById("analysisType"),
  ageBox: document.getElementById("ageBox"),
  age: document.getElementById("age"),
  agePill: document.getElementById("agePill"),
  preset: document.getElementById("preset"),

  inputTitle: document.getElementById("inputTitle"),
  inputHint: document.getElementById("inputHint"),
  hdrRow: document.getElementById("hdrRow"),
  inputs: document.getElementById("inputs"),

  normsEditorBlock: document.getElementById("normsEditorBlock"),
  toggleNormsBtn: document.getElementById("toggleNormsBtn"),
  normsBox: document.getElementById("normsBox"),
  norms: document.getElementById("norms"),

  checkBtn: document.getElementById("checkBtn"),
  fillDemoBtn: document.getElementById("fillDemoBtn"),
  clearBtn: document.getElementById("clearBtn"),
  csvBtn: document.getElementById("csvBtn"),

  report: document.getElementById("report"),
  error: document.getElementById("error"),
};

let lastReportRows = [];
let currentBloodNorms = structuredClone(DEFAULT_BLOOD_NORMS_BY_YEAR);

/** =========================================================
 *  4) Helpers
 *  ========================================================= */
function clampAge(a){
  if (Number.isNaN(a)) return 0;
  return Math.min(18, Math.max(0, a));
}
function pickYearBand(ageYears){ return Math.floor(clampAge(ageYears)); }
function setBandPill(){
  const type = els.analysisType.value;
  if (type === "blood"){
    const age = parseFloat(els.age.value);
    const y = pickYearBand(age);
    els.agePill.textContent = `–ì—Ä—É–ø–ø–∞: ${y} –≥–æ–¥(–ª–µ—Ç)`;
  } else {
    els.agePill.textContent = `–ì—Ä—É–ø–ø–∞: –∫–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞`;
  }
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
function statusClass(st){
  if (st.includes("‚úÖ")) return "s-ok";
  if (st.includes("üî∫")) return "s-hi";
  if (st.includes("üîª")) return "s-lo";
  return "s-warn";
}
function parseNum(val){
  if (val == null) return null;
  const s = String(val).trim();
  if (!s) return null;
  const normalized = s.replace(",", ".").replace(/\s+/g,"");
  const num = Number(normalized);
  return Number.isFinite(num) ? num : null;
}

/** =========================================================
 *  5) Presets (–≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
 *  ========================================================= */
const PRESETS = [
  {
    id:"blood_demo_6",
    type:"blood",
    title:"–ö—Ä–æ–≤—å ‚Äî –ø—Ä–∏–º–µ—Ä (6 –ª–µ—Ç)",
    age:6,
    values:{
      "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (WBC)":"6,1",
      "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (RBC)":"4,6",
      "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω (HGB)":"112",
      "–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (PLT)":"420",
      "–°–û–≠":"6",
    }
  },
  {
    id:"copro_demo_norm",
    type:"coprogram",
    title:"–ö–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –ø—Ä–∏–º–µ—Ä (–Ω–æ—Ä–º–∞)",
    values:{
      "–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è":"–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π",
      "–§–æ—Ä–º–∞ –ø–æ –ë—Ä–∏—Å—Ç–æ–ª—å—Å–∫–æ–π —à–∫–∞–ª–µ":"4",
      "–ó–∞–ø–∞—Ö":"–∫–∞–ª–æ–≤–∏–π",
      "–¶–≤–µ—Ç":"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π",
      "–†–µ–∞–∫—Ü–∏—è pH":"7.0",
      "–°–ª–∏–∑—å":"–Ω–µ—Ç",
      "–ñ–∏—Ä –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π":"–Ω–µ—Ç",
      "–ñ–∏—Ä–Ω—ã–µ –∫–∏—Å–ª–æ—Ç—ã":"–Ω–µ—Ç",
      "–ú—ã–ª–∞":"–º–∞–ª–æ",
      "–ü–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞":"–Ω–µ—Ç",
      "–ù–µ–ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞":"–µ—Å—Ç—å",
      "–í–Ω—É—Ç—Ä–∏–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª":"–Ω–µ—Ç",
      "–í–Ω–µ–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª":"–Ω–µ—Ç",
      "–î—Ä–æ–∂–∂–µ–ø–æ–¥–æ–±–Ω—ã–µ –≥—Ä–∏–±—ã":"–Ω–µ—Ç",
      "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (–∫–∞–ª)":"–Ω–µ—Ç",
      "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (–∫–∞–ª)":"–Ω–µ—Ç",
      "–≠–ø–∏—Ç–µ–ª–∏–π":"–Ω–µ–º–Ω–æ–≥–æ",
      "–ö–ª–æ—Å—Ç—Ä–∏–¥–∏–∏":"–Ω–µ—Ç",
      "–ô–æ–¥–æ—Ñ–∏–ª—å–Ω–∞—è —Ñ–ª–æ—Ä–∞":"–Ω–µ—Ç",
      "–ö—Ä–∏—Å—Ç–∞–ª–ª—ã":"–Ω–µ—Ç",
    }
  },
  {
    id:"copro_demo_bad",
    type:"coprogram",
    title:"–ö–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî –ø—Ä–∏–º–µ—Ä (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)",
    values:{
      "–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è":"–∂–∏–¥–∫–∏–π",
      "–§–æ—Ä–º–∞ –ø–æ –ë—Ä–∏—Å—Ç–æ–ª—å—Å–∫–æ–π —à–∫–∞–ª–µ":"6",
      "–ó–∞–ø–∞—Ö":"–∫–∏—Å–ª—ã–π",
      "–¶–≤–µ—Ç":"—á–µ—Ä–Ω—ã–π",
      "–†–µ–∞–∫—Ü–∏—è pH":"8.6",
      "–°–ª–∏–∑—å":"–µ—Å—Ç—å",
      "–ñ–∏—Ä –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π":"–µ—Å—Ç—å",
      "–ñ–∏—Ä–Ω—ã–µ –∫–∏—Å–ª–æ—Ç—ã":"–µ—Å—Ç—å",
      "–ú—ã–ª–∞":"–µ—Å—Ç—å",
      "–ü–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞":"–µ—Å—Ç—å",
      "–ù–µ–ø–µ—Ä–µ–≤–∞—Ä–∏–≤–∞–µ–º–∞—è –∫–ª–µ—Ç—á–∞—Ç–∫–∞":"–Ω–µ—Ç",
      "–í–Ω—É—Ç—Ä–∏–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª":"–µ—Å—Ç—å",
      "–í–Ω–µ–∫–ª–µ—Ç–æ—á–Ω—ã–π –∫—Ä–∞—Ö–º–∞–ª":"–µ—Å—Ç—å",
      "–î—Ä–æ–∂–∂–µ–ø–æ–¥–æ–±–Ω—ã–µ –≥—Ä–∏–±—ã":"–µ—Å—Ç—å",
      "–õ–µ–π–∫–æ—Ü–∏—Ç—ã (–∫–∞–ª)":"–µ—Å—Ç—å",
      "–≠—Ä–∏—Ç—Ä–æ—Ü–∏—Ç—ã (–∫–∞–ª)":"–µ—Å—Ç—å",
      "–≠–ø–∏—Ç–µ–ª–∏–π":"–º–Ω–æ–≥–æ",
      "–ö–ª–æ—Å—Ç—Ä–∏–¥–∏–∏":"–µ—Å—Ç—å",
      "–ô–æ–¥–æ—Ñ–∏–ª—å–Ω–∞—è —Ñ–ª–æ—Ä–∞":"–µ—Å—Ç—å",
      "–ö—Ä–∏—Å—Ç–∞–ª–ª—ã":"—Ç—Ä–∏–ø–µ–ª—å—Ñ–æ—Å—Ñ–∞—Ç—ã",
    }
  }
];

function rebuildPresetOptions(){
  const type = els.analysisType.value;
  els.preset.innerHTML = `<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>` +
    PRESETS.filter(p=>p.type===type).map(p=>`<option value="${p.id}">${escapeHtml(p.title)}</option>`).join("");
}

/** =========================================================
 *  6) Render inputs by type
 *  ========================================================= */
function buildInputs(){
  els.inputs.innerHTML = "";
  lastReportRows = [];
  els.report.innerHTML = "–ó–∞–ø–æ–ª–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù.";
  els.error.textContent = "";

  const type = els.analysisType.value;

  if (type === "blood"){
    els.inputTitle.textContent = "–í–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ö—Ä–æ–≤—å)";
    els.inputHint.textContent = "–í–ø–∏—à–∏ —á–∏—Å–ª–∞. –ú–æ–∂–Ω–æ —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–æ–π.";
    els.hdrRow.classList.remove("hidden");
    els.ageBox.classList.remove("hidden");
    els.normsEditorBlock.classList.remove("hidden");
    els.csvBtn.classList.remove("hidden");

    for (const it of BLOOD_INDICATORS){
      const name = it.key;
      const unit = it.unit;
      const row = document.createElement("div");
      row.innerHTML = `
        <div><b>${escapeHtml(name)}</b><div class="mini">–Ω–æ—Ä–º–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É</div></div>
        <input class="value" data-key="${escapeHtml(name)}" type="text" placeholder="‚Äî" />
        <input class="small" type="text" value="${escapeHtml(unit)}" disabled />
      `;
      els.inputs.appendChild(row);
    }

  } else {
    els.inputTitle.textContent = "–í–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ö–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞)";
    els.inputHint.textContent = "–í—ã–±–µ—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–∞—Ö –∏/–∏–ª–∏ –≤–≤–µ–¥–∏ pH. –ù–æ—Ä–º—ã –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ‚Äî –≤ –æ—Ç—á—ë—Ç–µ.";
    els.hdrRow.classList.remove("hidden"); // –æ—Å—Ç–∞–≤–∏–º, –Ω–æ –µ–¥–∏–Ω–∏—Ü—ã –±—É–¥—É—Ç –ø—É—Å—Ç—ã–µ
    els.ageBox.classList.add("hidden");    // –≤–æ–∑—Ä–∞—Å—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∫–æ–ø—Ä–æ–≥—Ä–∞–º–º—ã
    els.normsEditorBlock.classList.add("hidden");
    els.csvBtn.classList.remove("hidden");

    for (const f of COPROGRAM_FIELDS){
      const row = document.createElement("div");
      let inputHtml = "";
      if (f.type === "select"){
        inputHtml = `<select class="value" data-key="${escapeHtml(f.key)}">
          <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          ${f.options.map(o=>`<option value="${escapeHtml(o.v)}">${escapeHtml(o.t)}</option>`).join("")}
        </select>`;
      } else {
        inputHtml = `<input class="value" data-key="${escapeHtml(f.key)}" type="text" placeholder="${escapeHtml(f.placeholder || "‚Äî")}" />`;
      }

      row.innerHTML = `
        <div><b>${escapeHtml(f.key)}</b><div class="mini">–∫–æ–ø—Ä–æ–≥—Ä–∞–º–º–∞</div></div>
        ${inputHtml}
        <input class="small" type="text" value="${escapeHtml(f.unit || "")}" disabled />
      `;
      els.inputs.appendChild(row);
    }
  }

  setBandPill();
  rebuildPresetOptions();
}

/** =========================================================
 *  7) BLOOD: norms editor (–∫–∞–∫ –±—ã–ª–æ)
 *  ========================================================= */
function loadBloodNormsFromStorage(){
  const saved = localStorage.getItem("norms_by_year_v1");
  if (!saved) return structuredClone(DEFAULT_BLOOD_NORMS_BY_YEAR);
  try{
    const parsed = JSON.parse(saved);
    return parsed;
  }catch(e){
    return structuredClone(DEFAULT_BLOOD_NORMS_BY_YEAR);
  }
}
function saveBloodNormsToStorage(norms){
  localStorage.setItem("norms_by_year_v1", JSON.stringify(norms));
}
function initNormsEditor(){
  currentBloodNorms = loadBloodNormsFromStorage();
  els.norms.value = JSON.stringify(currentBloodNorms, null, 2);
}

/** =========================================================
 *  8) Evaluate
 *  ========================================================= */
function evaluateBlood(){
  const age = parseFloat(els.age.value);
  const y = pickYearBand(age);
  const band = currentBloodNorms[String(y)] || {};

  const inputs = [...document.querySelectorAll('[data-key]')];
  const rows = [];

  for (const input of inputs){
    const name = input.dataset.key;
    const raw = input.value;
    const val = parseNum(raw);

    const n = band[name] || null;
    const unit = (n && n.unit) ? n.unit : (BLOOD_INDICATORS.find(x=>x.key===name)?.unit || "");
    const min = n ? n.min : null;
    const max = n ? n.max : null;

    let normText = "‚Äî";
    let status = "‚Äî";

    if (val == null){
      status = "‚Äî";
    } else if (min == null || max == null){
      status = "‚ö†Ô∏è –Ω–æ—Ä–º–∞ –Ω–µ –∑–∞–¥–∞–Ω–∞";
    } else {
      normText = `${min}‚Äì${max}`;
      if (val < min) status = "üîª –Ω–∏–∂–µ –Ω–æ—Ä–º—ã";
      else if (val > max) status = "üî∫ –≤—ã—à–µ –Ω–æ—Ä–º—ã";
      else status = "‚úÖ –Ω–æ—Ä–º–∞";
    }

    rows.push({
      name,
      value: (val == null ? "" : val),
      unit,
      normText,
      status,
      reason: ""
    });
  }

  lastReportRows = rows;
  renderReport(rows, "blood");
}

function evaluateCoprogram(){
  const inputs = [...document.querySelectorAll('[data-key]')];
  const rows = [];

  for (const input of inputs){
    const name = input.dataset.key;
    const raw = (input.tagName.toLowerCase()==="select") ? input.value : input.value.trim();

    let status = "‚Äî";
    let normText = "‚Äî";
    let reason = "";

    const rule = COPROGRAM_RULES[name];

    if (!raw){
      status = "‚Äî";
    } else if (!rule){
      status = "‚ö†Ô∏è –ø—Ä–∞–≤–∏–ª–æ –Ω–µ –∑–∞–¥–∞–Ω–æ";
    } else if (name === "–†–µ–∞–∫—Ü–∏—è pH"){
      const val = parseNum(raw);
      if (val == null){
        status = "‚ö†Ô∏è –Ω–µ–≤–µ—Ä–Ω–æ–µ —á–∏—Å–ª–æ";
      } else {
        // –≤—ã–±—Ä–∞—Ç—å –Ω–æ—Ä–º—É –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É: –¥–æ/–ø–æ—Å–ª–µ –≥–æ–¥–∞
        const age = clampAge(parseFloat(els.age.value || "6"));
        const isUnder1 = age < 1;

        // pH: –≤ —Ç–≤–æ—ë–º –ª–∏—Å—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ –ì–í –∏ –ò–í (–∏—Ö –º—ã –Ω–µ –∑–Ω–∞–µ–º),
        // –ø–æ—ç—Ç–æ–º—É –ª–æ–≥–∏–∫–∞: –¥–æ 1 –≥–æ–¥–∞ —Å—á–∏—Ç–∞–µ–º "–Ω–æ—Ä–º–∞ –µ—Å–ª–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ª—é–±–æ–π –∏–∑ –¥–≤—É—Ö –¥–µ—Ç—Å–∫–∏—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤",
        // —Å—Ç–∞—Ä—à–µ –≥–æ–¥–∞: 6‚Äì8.
        if (isUnder1){
          const ok = (val>=4.8 && val<=5.8) || (val>=6.8 && val<=7.0);
          normText = `0‚Äì1 –≥–æ–¥: 4.8‚Äì5.8 (–ì–í) –∏–ª–∏ 6.8‚Äì7.0 (–ò–í)`;
          if (ok){
            status = "‚úÖ –Ω–æ—Ä–º–∞";
          } else if (val < 4.8){
            status = "üîª –Ω–∏–∂–µ –Ω–æ—Ä–º—ã";
            reason = rule.explainLow;
          } else if (val > 7.0){
            status = "üî∫ –≤—ã—à–µ –Ω–æ—Ä–º—ã";
            reason = rule.explainHigh;
          } else {
            status = "‚ö†Ô∏è –≤–Ω–µ –Ω–æ—Ä–º—ã";
            reason = "pH –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –ì–í, –Ω–∏ –ò–í (–ø–æ —Ç–≤–æ–µ–π –ø–∞–º—è—Ç–∫–µ).";
          }
        } else {
          normText = `—Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞: 6.0‚Äì8.0`;
          if (val < 6.0){
            status = "üîª –Ω–∏–∂–µ –Ω–æ—Ä–º—ã";
            reason = rule.explainLow;
          } else if (val > 8.0){
            status = "üî∫ –≤—ã—à–µ –Ω–æ—Ä–º—ã";
            reason = rule.explainHigh;
          } else {
            status = "‚úÖ –Ω–æ—Ä–º–∞";
          }
        }
      }
    } else {
      // —Å–µ–ª–µ–∫—Ç—ã
      const norms = rule.norm || [];
      const warn = rule.warn || [];
      normText = norms.length ? norms.map(x=>x).join(", ") : "‚Äî";

      if (norms.includes(raw)){
        // –Ω–æ—Ä–º, –Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–µ–ª–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ü–≤–µ—Ç —Å–≤–µ—Ç–ª—ã–π/—Ç—ë–º–Ω—ã–π)
        if (warn.includes(raw)){
          status = "‚ö†Ô∏è –≤–∞—Ä–∏–∞–Ω—Ç –Ω–æ—Ä–º—ã";
          reason = (rule.explain && rule.explain[raw]) ? rule.explain[raw] : "";
        } else {
          status = "‚úÖ –Ω–æ—Ä–º–∞";
        }
      } else {
        status = "üî∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ";
        if (rule.explain && rule.explain[raw]) reason = rule.explain[raw];
        else reason = "–ï—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –Ω–æ—Ä–º—ã –ø–æ –ø–∞–º—è—Ç–∫–µ.";
      }
    }

    rows.push({
      name,
      value: raw,
      unit: "",
      normText: (name==="–†–µ–∞–∫—Ü–∏—è pH" ? normText : "—Å–º. –Ω–æ—Ä–º—É"),
      status,
      reason
    });
  }

  lastReportRows = rows;
  renderReport(rows, "coprogram");
}

function renderReport(rows, type){
  const headerNorm = (type==="blood") ? "–ù–æ—Ä–º–∞" : "–ù–æ—Ä–º–∞/–æ–∂–∏–¥–∞–Ω–∏–µ";
  const headerReason = "–ü–æ—è—Å–Ω–µ–Ω–∏–µ";

  const html = `
    <table class="table">
      <thead>
        <tr>
          <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
          <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
          <th>–ï–¥.</th>
          <th>${headerNorm}</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>${headerReason}</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const stClass = statusClass(r.status);
          const reasonBlock = r.reason
            ? `<details><summary>–ø–æ–∫–∞–∑–∞—Ç—å</summary><div class="mini">${escapeHtml(r.reason)}</div></details>`
            : `<span class="mut">‚Äî</span>`;

          return `
            <tr>
              <td><b>${escapeHtml(r.name)}</b></td>
              <td>${escapeHtml(r.value)}</td>
              <td>${escapeHtml(r.unit || "")}</td>
              <td>${escapeHtml(r.normText || "‚Äî")}</td>
              <td class="${stClass}">${escapeHtml(r.status)}</td>
              <td>${reasonBlock}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;

  els.report.innerHTML = html;
}

/** =========================================================
 *  9) CSV download (UTF-8 + BOM —á—Ç–æ–±—ã Excel –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–ª)
 *  ========================================================= */
function downloadCSV(){
  if (!lastReportRows.length){
    els.error.textContent = "‚úñÔ∏è –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª—Å—è –æ—Ç—á—ë—Ç.";
    return;
  }
  const header = ["–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å","–ó–Ω–∞—á–µ–Ω–∏–µ","–ï–¥.","–ù–æ—Ä–º–∞","–°—Ç–∞—Ç—É—Å","–ü–æ—è—Å–Ω–µ–Ω–∏–µ"];
  const lines = [header.join(";")].concat(
    lastReportRows.map(r => [
      r.name, r.value ?? "", r.unit ?? "", r.normText ?? "", r.status ?? "", (r.reason ?? "")
    ].map(x => String(x).replaceAll(";", ",")).join(";"))
  );

  const bom = "\uFEFF"; // BOM –¥–ª—è Excel
  const blob = new Blob([bom + lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "report.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** =========================================================
 *  10) Actions
 *  ========================================================= */
function clearAll(){
  for (const el of document.querySelectorAll('[data-key]')){
    if (el.tagName.toLowerCase()==="select") el.value = "";
    else el.value = "";
  }
  els.report.innerHTML = "–ó–∞–ø–æ–ª–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏ ‚Äú–ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Äù.";
  els.error.textContent = "";
  lastReportRows = [];
}

function fillExample(){
  const type = els.analysisType.value;
  const preset = PRESETS.find(p=>p.type===type);
  if (!preset) return;

  if (type==="blood" && preset.age != null){
    els.age.value = preset.age;
    setBandPill();
  }
  applyValues(preset.values);
}

function applyValues(values){
  for (const el of document.querySelectorAll('[data-key]')){
    const k = el.dataset.key;
    if (!(k in values)) continue;
    if (el.tagName.toLowerCase()==="select") el.value = String(values[k]);
    else el.value = String(values[k]);
  }
}

function onPresetChange(){
  const id = els.preset.value;
  if (!id) return;
  const p = PRESETS.find(x=>x.id===id);
  if (!p) return;

  if (p.type==="blood" && p.age != null){
    els.age.value = p.age;
    setBandPill();
  }
  applyValues(p.values);
}

function onCheck(){
  els.error.textContent = "";
  const type = els.analysisType.value;

  if (type==="blood"){
    // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–æ—Ä–º—ã –∏–∑ textarea (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å)
    if (!els.normsBox.classList.contains("hidden")){
      try{
        const parsed = JSON.parse(els.norms.value);
        currentBloodNorms = parsed;
        saveBloodNormsToStorage(parsed);
      }catch(e){
        els.error.textContent = "‚úñÔ∏è –û—à–∏–±–∫–∞ –≤ JSON –Ω–æ—Ä–º. –ò—Å–ø—Ä–∞–≤—å –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.";
        return;
      }
    }
    evaluateBlood();
  } else {
    evaluateCoprogram();
  }
}

/** =========================================================
 *  11) Init + events
 *  ========================================================= */
els.analysisType.addEventListener("change", ()=>{
  buildInputs();
  initNormsEditor();
});
els.age.addEventListener("input", ()=> setBandPill());
els.preset.addEventListener("change", onPresetChange);

els.checkBtn.addEventListener("click", onCheck);
els.fillDemoBtn.addEventListener("click", fillExample);
els.clearBtn.addEventListener("click", clearAll);
els.csvBtn.addEventListener("click", downloadCSV);

els.toggleNormsBtn?.addEventListener("click", ()=>{
  els.normsBox.classList.toggle("hidden");
});

buildInputs();
initNormsEditor();
</script>
</body>
</html>
