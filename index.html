<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Проверка анализов (дети/подростки)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#101828; --muted:#667085;
      --line:#e5e7eb; --ok:#12b76a; --warn:#f79009; --bad:#f04438; --info:#3b82f6;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:1100px; margin:28px auto; padding:0 14px;}
    h1{margin:0 0 6px; font-size:22px}
    .sub{margin:0 0 18px; color:var(--muted); font-size:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:14px}
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); padding:16px;
      box-shadow:0 10px 30px rgba(16,24,40,.05);
    }
    .top{
      display:grid; grid-template-columns:1.1fr .9fr; gap:14px;
    }
    @media (max-width:900px){ .top{grid-template-columns:1fr} }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, button{
      border:1px solid var(--line); border-radius:12px; padding:10px 12px;
      background:#fff; color:var(--text); font-size:14px;
    }
    input{min-width:170px}
    .mini{min-width:120px}
    button{
      cursor:pointer; font-weight:600;
    }
    button.primary{background:#111827; color:#fff; border-color:#111827}
    button.ghost{background:#fff}
    button:disabled{opacity:.55; cursor:not-allowed}
    .note{font-size:12px; color:var(--muted); margin-top:8px}
    table{width:100%; border-collapse:collapse}
    th,td{border-top:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top}
    th{font-size:12px; color:var(--muted); font-weight:600}
    td .name{font-weight:700}
    td .small{font-size:12px; color:var(--muted)}
    .val{width:120px}
    .unit{white-space:nowrap; color:var(--muted); font-size:13px}
    .badge{
      display:inline-flex; gap:6px; align-items:center;
      padding:5px 10px; border-radius:999px; font-size:12px; font-weight:700;
      border:1px solid var(--line); background:#fff;
    }
    .ok{color:var(--ok)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .muted{color:var(--muted)}
    .reasonBtn{
      padding:6px 10px; font-size:12px; border-radius:10px;
    }
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; padding:16px;
    }
    .modal{
      max-width:720px; width:100%;
      background:#fff; border-radius:16px; border:1px solid var(--line);
      padding:16px; box-shadow:0 30px 80px rgba(0,0,0,.25);
    }
    .modal h3{margin:0 0 8px}
    .modal .cols{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .modal .cols{grid-template-columns:1fr} }
    .modal ul{margin:8px 0 0; padding-left:18px}
    .modal .x{float:right; border:none; font-size:18px; padding:2px 8px; border-radius:10px}
    .hint{font-size:13px; color:var(--muted); margin-top:8px}
    .footerWarn{
      margin-top:10px; font-size:12px; color:var(--muted);
      border-top:1px dashed var(--line); padding-top:10px
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Проверка анализов крови</h1>
  <p class="sub">Вводишь возраст и значения — сайт подставляет нормы по возрасту и показывает отклонения. Не является медицинским диагнозом.</p>

  <div class="grid">
    <div class="card top">
      <div>
        <div class="row">
          <div>
            <label>Возраст (лет, можно дробно; пример: 0.5 = 6 месяцев)</label>
            <input id="ageYears" class="mini" type="number" step="0.1" min="0" value="2" />
          </div>
          <div>
            <label>Пол (важно для HCT 12+)</label>
            <select id="sex" class="mini">
              <option value="any">не важно</option>
              <option value="f">девочка</option>
              <option value="m">мальчик</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="primary" id="btnCheck">Проверить</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="ghost" id="btnDemo">Заполнить пример</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="ghost" id="btnClear">Очистить</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="ghost" id="btnCSV">Скачать CSV</button>
          </div>
        </div>
        <div class="note" id="ageGroupNote"></div>
      </div>

      <div>
        <div class="note">
          Формат ввода: просто числа. Можно с запятой или точкой (например <b>6,1</b>).
        </div>
        <div class="footerWarn">
          ⚠️ Нормы могут отличаться в разных лабораториях и методиках. При отклонениях лучше обсудить результаты с врачом.
        </div>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th>Показатель</th>
            <th>Значение</th>
            <th>Ед.</th>
            <th>Норма</th>
            <th>Статус</th>
            <th>Причины (если есть)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint">
        Я добавил нормы из твоих фото: WBC, RBC, HGB, HCT, MCV, MCH, MCHC, RDW-CV, RDW-SD, PLT, PCT, PDW, P-LCR, СОЭ, LY%, MO%, NE abs, EO abs, BA%.
        Если какого-то показателя в анализе нет — просто оставь пустым.
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="x" id="modalClose" title="Закрыть">✕</button>
    <h3 id="modalTitle">Причины</h3>
    <div class="cols">
      <div>
        <div><b>Причины повышения</b></div>
        <ul id="modalHigh"></ul>
      </div>
      <div>
        <div><b>Причины понижения</b></div>
        <ul id="modalLow"></ul>
      </div>
    </div>
    <div class="hint">Это подсказки из твоих памяток (не диагноз).</div>
  </div>
</div>

<script>
/** =========================
 *  1) НОРМЫ (по твоим фото)
 *  Возраст в месяцах (minIncl..maxExcl)
 *  ========================= */
const norms = {
  // лейкоциты WBC 10^9/л
  "Лейкоциты (WBC)": {
    unit: "10^9/л",
    ranges: [
      {minM:0,   maxM:1,   min:9.0,  max:30.0, label:"0–1 месяц"},
      {minM:1,   maxM:12,  min:6.0,  max:17.5, label:"1 мес–1 год"},
      {minM:12,  maxM:24,  min:6.0,  max:17.0, label:"1–2 года"},
      {minM:24,  maxM:48,  min:5.5,  max:15.5, label:"2–4 года"},
      {minM:48,  maxM:72,  min:5.0,  max:14.5, label:"4–6 лет"},
      {minM:72,  maxM:180, min:4.5,  max:13.5, label:"6–15 лет"},
      {minM:180, maxM:9999,min:4.0,  max:9.0,  label:"15+ лет"},
    ],
    reasons: {
      high: ["воспалительные процессы","бактериальные инфекции","питание с обилием углеводов","сдача анализа сразу после еды"],
      low: ["стресс","надпочечниковая усталость","гипотиреоз","анемия","дефицит B12","вирусная инфекция"]
    }
  },

  // эритроциты RBC 10^12/л
  "Эритроциты (RBC)": {
    unit: "10^12/л",
    ranges: [
      {minM:0,  maxM:1,   min:3.8, max:5.6, label:"0–1 месяц"},
      {minM:1,  maxM:6,   min:3.5, max:4.5, label:"1–6 месяцев"},
      {minM:6,  maxM:12,  min:3.9, max:5.1, label:"6–12 месяцев"},
      {minM:12, maxM:144, min:3.9, max:5.5, label:"1–12 лет"},
      {minM:144,maxM:9999,min:4.3, max:5.5, label:"12+ лет"},
    ],
    reasons: {
      high: ["подъём на высоту (жители высокогорья)","физические и эмоциональные нагрузки","дегидратация","ожирение"],
      low: ["дефицит витамина B12, B9, B6","дефицит железа","заболевания почек и печени","скрытое воспаление"]
    }
  },

  // гемоглобин HGB г/л
  "Гемоглобин (HGB)": {
    unit: "г/л",
    ranges: [
      {minM:0,  maxM:1,   min:130, max:200, label:"0–1 месяц"},
      {minM:1,  maxM:6,   min:90,  max:120, label:"1–6 месяцев"},
      {minM:6,  maxM:60,  min:115, max:140, label:"6 мес–5 лет"},
      {minM:60, maxM:144, min:125, max:135, label:"5–12 лет"},
      {minM:144,maxM:9999,min:125, max:140, label:"12+ лет"},
    ],
    reasons: {
      high: ["обезвоживание","гипоксия","синдром раздражённого кишечника","сахарный диабет","длительные физические нагрузки","заболевание костного мозга"],
      low: ["дефицит белка","витамина C, меди, марганца","витаминов B12, B9, B1","недостаточное поступление железа","гипоацидные состояния","вегетарианство","кровопотери"]
    }
  },

  // гематокрит HCT %
  "Гематокрит (HCT)": {
    unit: "%",
    ranges: [
      {minM:0,  maxM:1,   min:34, max:55, label:"0–1 месяц"},
      {minM:1,  maxM:6,   min:32, max:43, label:"1–6 месяцев"},
      {minM:6,  maxM:24,  min:33, max:39, label:"6 мес–2 года"},
      {minM:24, maxM:72,  min:34, max:40, label:"2–6 лет"},
      {minM:72, maxM:144, min:35, max:45, label:"6–12 лет"},
      // 12+ зависит от пола
      {minM:144,maxM:9999, min:36, max:46, sex:"f", label:"12+ (девочки)"},
      {minM:144,maxM:9999, min:37, max:49, sex:"m", label:"12+ (мальчики)"},
    ],
    reasons: {
      high: ["обезвоживание","гипоксия","нарушение функций почек"],
      low: ["анемия","кровопотери","гипергидратация"]
    }
  },

  // MCV фл
  "Средний объём эритроцитов (MCV)": {
    unit: "фл",
    ranges: [
      {minM:0,  maxM:1,   min:80, max:95, label:"0–1 месяц"},
      {minM:1,  maxM:3,   min:88, max:100,label:"1–3 месяца"},
      {minM:3,  maxM:6,   min:75, max:95, label:"3–6 месяцев"},
      {minM:6,  maxM:24,  min:70, max:85, label:"6 мес–2 года"},
      {minM:24, maxM:144, min:75, max:87, label:"2–12 лет"},
      {minM:144,maxM:9999,min:88, max:95, label:"12+ лет"},
    ],
    reasons: {
      high: ["дефицит витаминов B9, B12","снижение уровня натрия в крови"],
      low: ["дефицит витамина C, B, меди","снижение кислотности желудочного сока","повышение уровня натрия"]
    }
  },

  // MCH пг
  "Средн. содержание гемоглобина в эритроците (MCH)": {
    unit: "пг",
    ranges: [
      {minM:0,  maxM:1,   min:31, max:37, label:"0–1 месяц"},
      {minM:1,  maxM:6,   min:27, max:36, label:"1–6 месяцев"},
      {minM:6,  maxM:24,  min:25, max:28, label:"6 мес–2 года"},
      {minM:24, maxM:9999,min:28, max:32, label:"2 года и старше"},
    ],
    reasons: {
      high: ["дефицит витаминов B9, B12"],
      low: ["дефицит железа","иногда дефицит меди","дефицит витаминов группы B"]
    }
  },

  // MCHC г/л (без возрастных групп)
  "Средн. концентрация гемоглобина в эритроцитах (MCHC)": {
    unit: "г/л",
    ranges: [{minM:0, maxM:9999, min:320, max:360, label:"все возраста"}],
    reasons: {
      high: ["дефицит витамина B9, B12, B2","гипотиреоз"],
      low: ["железодефицитная анемия","гемолитическая анемия","дефицит витамина C","понижение кислотности желудочного сока"]
    }
  },

  // RDW-CV %
  "RDW-CV": {
    unit: "%",
    ranges: [{minM:0, maxM:9999, min:11, max:15, label:"все возраста"}],
    reasons: {
      high: ["анизоцитоз: часто бывает при железодефиците (особенно если маленькие эритроциты)"],
      low: ["обычно клинически незначимо"]
    }
  },

  // RDW-SD фл
  "RDW-SD": {
    unit: "фл",
    ranges: [{minM:0, maxM:9999, min:35, max:60, label:"все возраста"}],
    reasons: {
      high: ["анизоцитоз: разный размер эритроцитов"],
      low: ["обычно клинически незначимо"]
    }
  },

  // PLT 10^9/л
  "Тромбоциты (PLT)": {
    unit: "10^9/л",
    ranges: [
      {minM:0,  maxM:1,   min:180, max:490, label:"новорождённые"},
      {minM:1,  maxM:12,  min:180, max:400, label:"0–1 год"},
      {minM:12, maxM:60,  min:160, max:390, label:"1–5 лет"},
      {minM:60, maxM:120, min:160, max:380, label:"6–10 лет"},
      {minM:120,maxM:156, min:160, max:360, label:"10–13 лет"},
      {minM:156,maxM:180, min:180, max:320, label:"13–15 лет"},
      {minM:180,maxM:9999,min:180, max:390, label:"15+ лет"},
    ],
    reasons: {
      high: ["обезвоживание (рвота, диарея)","недостаточное употребление жидкости","активные виды спорта","лихорадка с повышенным потоотделением","анемия разной этиологии","воспалительные процессы","дефицит витамина E"],
      low: ["герпес-вирусные инфекции","приём лекарственных препаратов","дефицит витамина B9, B12","вакцинация","аутоиммунные заболевания (аутоиммунный тиреоидит, ревматоидный артрит, системная красная волчанка)"]
    }
  },

  // PCT %
  "Тромбокрит (PCT)": {
    unit: "%",
    ranges: [{minM:0, maxM:9999, min:0.108, max:0.282, label:"все возраста"}],
    reasons: {
      high: ["гипертиреоз","сахарный диабет","воспалительные заболевания"],
      low: ["повышенное разрушение тромбоцитов","анемия","аллергия","дефицит B9"]
    }
  },

  // PDW %
  "PDW": {
    unit: "%",
    ranges: [{minM:0, maxM:9999, min:9, max:16, label:"все возраста"}],
    reasons: {
      high: ["отравление свинцом","после физической нагрузки","патологии печени","кровопотеря"],
      low: ["вирусные заболевания","дефицит B9 и B12"]
    }
  },

  // P-LCR %
  "P-LCR": {
    unit: "%",
    ranges: [{minM:0, maxM:9999, min:13, max:43, label:"все возраста"}],
    reasons: {
      high: ["после травм и операций","инфекционные заболевания (бактериальные/вирусные/грибковые)","интоксикации химическими веществами","ревматоидные заболевания","сахарный диабет"],
      low: ["интоксикация тяжёлыми металлами","дефицит витаминов группы B","туберкулёз","цинга"]
    }
  },

  // СОЭ мм/ч
  "СОЭ": {
    unit: "мм/ч",
    ranges: [
      {minM:0,  maxM:1,   min:2, max:4,  label:"0–1 месяц"},
      {minM:1,  maxM:24,  min:4, max:10, label:"1 мес–2 года"},
      {minM:24, maxM:144, min:4, max:15, label:"2–12 лет"},
      {minM:144,maxM:9999,min:4, max:18, label:"12+ лет"},
    ],
    reasons: {
      high: ["любые воспалительные заболевания","опухолевые процессы","острое отравление тяжёлыми металлами","менструация","приём некоторых лекарственных препаратов"],
      low: ["эпилепсия","гипоальбуминемия","гепатит"]
    }
  },

  // Лимфоциты % (LY%)
  "Лимфоциты (LY), %": {
    unit: "%",
    ranges: [
      {minM:0,  maxM:1,   min:45, max:70, label:"0–1 месяц"},
      {minM:1,  maxM:6,   min:45, max:70, label:"1–6 месяцев"},
      {minM:6,  maxM:12,  min:50, max:70, label:"6–12 месяцев"},
      {minM:12, maxM:36,  min:35, max:60, label:"1–3 года"},
      {minM:36, maxM:72,  min:33, max:55, label:"3–6 лет"},
      {minM:72, maxM:144, min:30, max:46, label:"6–12 лет"},
      {minM:144,maxM:9999,min:18, max:45, label:"12+ лет"},
    ],
    reasons: {
      high: ["вирусные заболевания (ЦМВ, Эпштейн-Барр, аденовирус)","ветрянка","скарлатина","коклюш","кожный зуд","язвенный колит","болезнь Крона"],
      low: ["бактериальные инфекции","приём кортикостероидов","лечение кортикостероидами","иммунодефицит","анемия (витамин B3)","накануне"]
    }
  },

  // Моноциты % (MO%)
  "Моноциты (MO), %": {
    unit: "%",
    ranges: [
      {minM:0,    maxM:0.5, min:5, max:15, label:"0–2 недели"},
      {minM:0.5,  maxM:12,  min:4, max:10, label:"2 недели–1 год"},
      {minM:12,   maxM:24,  min:3, max:10, label:"1–2 года"},
      {minM:24,   maxM:9999,min:3, max:9,  label:"2 года и старше"},
    ],
    reasons: {
      high: ["инфекции (ЦМВ, Эпштейн-Барр, коклюш)","туберкулёз","паразитарные инвазии","псориаз","хроническое воспаление","ревматоидный артрит"],
      low: ["бактериальные инфекции","сепсис","дефицит B12","иммунодефицит"]
    }
  },

  // Нейтрофилы abs (добавлено, т.к. на листе именно abs)
  "Нейтрофилы (NE), абс.": {
    unit: "10^9/л",
    ranges: [
      {minM:0,  maxM:1,   min:1.0, max:20.0, label:"0–1 месяц"},
      {minM:1,  maxM:3,   min:1.0, max:9.5,  label:"1–3 месяца"},
      {minM:3,  maxM:6,   min:1.0, max:8.5,  label:"3–6 месяцев"},
      {minM:6,  maxM:60,  min:1.5, max:8.5,  label:"6 мес–5 лет"},
      {minM:60, maxM:216, min:1.7, max:7.5,  label:"5–18 лет"},
      {minM:216,maxM:9999,min:1.7, max:7.5,  label:"18+ (оставлено как 5–18)"},
    ],
    reasons: {
      high: ["бактериальная инфекция","интоксикация","воспаление"],
      low: ["железодефицит","дефицит B12, B9","вирусная нагрузка"]
    }
  },

  // Эозинофилы abs (на листе abs)
  "Эозинофилы (EO), абс.": {
    unit: "10^9/л",
    ranges: [
      {minM:0,  maxM:1,   min:0, max:0.5, label:"0–1 месяц"},
      {minM:1,  maxM:5,   min:0, max:0.6, label:"1–5 месяцев"},
      {minM:5,  maxM:24,  min:0, max:0.5, label:"5 мес–2 года"},
      {minM:24, maxM:60,  min:0, max:0.7, label:"2–5 лет"},
      {minM:60, maxM:9999,min:0, max:0.5, label:"5 лет и старше"},
    ],
    reasons: {
      high: ["аллергическая реакция","глистная инвазия","воспалительные процессы"],
      low: ["ферментативная недостаточность","недостаточность поджелудочной железы"]
    }
  },

  // Базофилы % (на листе общий референс)
  "Базофилы (BA), %": {
    unit: "%",
    ranges: [{minM:0, maxM:9999, min:0, max:1, label:"все возраста (0–1%)"}],
    reasons: {
      high: ["дефицит железа","вирусная/бактериальная инфекция","воспалительные процессы","глистная инвазия","менструация","гипотиреоз"],
      low: ["дефицит B9, B12","инфекционные заболевания"]
    }
  }
};

/** =========================
 *  2) ПОЛЯ ввода (что показывать на странице)
 *  ========================= */
const fields = [
  {key:"Лейкоциты (WBC)"},
  {key:"Эритроциты (RBC)"},
  {key:"Гемоглобин (HGB)"},
  {key:"Гематокрит (HCT)"},
  {key:"Средний объём эритроцитов (MCV)"},
  {key:"Средн. содержание гемоглобина в эритроците (MCH)"},
  {key:"Средн. концентрация гемоглобина в эритроцитах (MCHC)"},
  {key:"RDW-CV"},
  {key:"RDW-SD"},
  {key:"Тромбоциты (PLT)"},
  {key:"Тромбокрит (PCT)"},
  {key:"PDW"},
  {key:"P-LCR"},
  {key:"СОЭ"},
  {key:"Лимфоциты (LY), %"},
  {key:"Моноциты (MO), %"},
  {key:"Нейтрофилы (NE), абс."},
  {key:"Эозинофилы (EO), абс."},
  {key:"Базофилы (BA), %"},
];

/** =========================
 *  3) UI
 *  ========================= */
const tbody = document.querySelector("#tbl tbody");
const ageYearsEl = document.getElementById("ageYears");
const sexEl = document.getElementById("sex");
const ageGroupNote = document.getElementById("ageGroupNote");

let lastReport = [];

function parseNum(v){
  if(v==null) return null;
  const s = String(v).trim().replace(",", ".");
  if(!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function yearsToMonths(y){ return Math.max(0, y*12); }

function pickRange(normObj, ageM, sex){
  if(!normObj || !normObj.ranges) return null;
  // сначала попробуем sex-специфичные, если возраст 12+ и пол указан
  const rs = normObj.ranges;
  let cand = rs.filter(r => ageM >= r.minM && ageM < r.maxM);
  if(!cand.length) return null;

  // если есть варианты по полу — выбираем подходящий
  const sexCand = cand.filter(r => r.sex);
  if(sexCand.length){
    const exact = sexCand.find(r => r.sex === sex);
    if(exact) return exact;
    // если пол не выбран — не угадываем
    return null;
  }
  return cand[0];
}

function fmtNorm(r){
  if(!r) return "—";
  return `${r.min}–${r.max} ${r.label ? " ("+r.label+")" : ""}`;
}

function statusFor(value, r){
  if(value==null) return {text:"—", cls:"muted", flag:"none"};
  if(!r) return {text:"норма не задана", cls:"warn", flag:"no_norm"};
  if(value < r.min) return {text:"ниже нормы", cls:"bad", flag:"low"};
  if(value > r.max) return {text:"выше нормы", cls:"bad", flag:"high"};
  return {text:"норма", cls:"ok", flag:"ok"};
}

function buildTable(){
  tbody.innerHTML = "";
  fields.forEach((f, idx) => {
    const n = norms[f.key];
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>
        <div class="name">${f.key}</div>
        <div class="small">${n ? "нормы по возрасту" : "нет настроек"}</div>
      </td>
      <td>
        <input class="val" inputmode="decimal" placeholder="—" data-key="${f.key}" />
      </td>
      <td class="unit">${n ? n.unit : "—"}</td>
      <td data-norm="${f.key}" class="small">—</td>
      <td data-status="${f.key}"><span class="badge muted">—</span></td>
      <td data-reason="${f.key}"></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateNormsPreview(){
  const ageY = parseNum(ageYearsEl.value);
  const ageM = yearsToMonths(ageY ?? 0);
  const sex = sexEl.value;

  ageGroupNote.textContent = `Возраст в месяцах: ${Math.round(ageM)}. Пол: ${sex==="any"?"не важно":(sex==="f"?"девочка":"мальчик")}.`;

  fields.forEach(f => {
    const n = norms[f.key];
    const cell = document.querySelector(`[data-norm="${CSS.escape(f.key)}"]`);
    if(!cell) return;
    const r = pickRange(n, ageM, sex);
    cell.textContent = n ? fmtNorm(r) : "—";
  });
}

function runCheck(){
  const ageY = parseNum(ageYearsEl.value);
  const ageM = yearsToMonths(ageY ?? 0);
  const sex = sexEl.value;

  lastReport = [];

  fields.forEach(f => {
    const n = norms[f.key];
    const r = pickRange(n, ageM, sex);

    const inp = document.querySelector(`input[data-key="${CSS.escape(f.key)}"]`);
    const v = parseNum(inp.value);

    const st = statusFor(v, r);

    const statusCell = document.querySelector(`[data-status="${CSS.escape(f.key)}"]`);
    if(statusCell){
      statusCell.innerHTML = `<span class="badge ${st.cls}">${st.text}</span>`;
    }

    const reasonCell = document.querySelector(`[data-reason="${CSS.escape(f.key)}"]`);
    if(reasonCell){
      if(n && n.reasons && (n.reasons.high?.length || n.reasons.low?.length)){
        const btn = document.createElement("button");
        btn.className = "ghost reasonBtn";
        btn.textContent = "показать";
        btn.onclick = () => openReasons(f.key, st.flag);
        reasonCell.innerHTML = "";
        reasonCell.appendChild(btn);
      }else{
        reasonCell.innerHTML = `<span class="small muted">—</span>`;
      }
    }

    lastReport.push({
      name: f.key,
      value: v,
      unit: n ? n.unit : "",
      norm: r ? `${r.min}–${r.max}` : "",
      status: st.text
    });
  });
}

/** =========================
 *  4) MODAL причин
 *  ========================= */
const modalBack = document.getElementById("modalBack");
const modalClose = document.getElementById("modalClose");
const modalTitle = document.getElementById("modalTitle");
const modalHigh = document.getElementById("modalHigh");
const modalLow = document.getElementById("modalLow");

function openReasons(key, flag){
  const n = norms[key];
  modalTitle.textContent = `Причины: ${key}`;
  modalHigh.innerHTML = "";
  modalLow.innerHTML = "";

  const hi = n?.reasons?.high || [];
  const lo = n?.reasons?.low || [];

  (hi.length ? hi : ["—"]).forEach(t=>{
    const li=document.createElement("li"); li.textContent=t; modalHigh.appendChild(li);
  });
  (lo.length ? lo : ["—"]).forEach(t=>{
    const li=document.createElement("li"); li.textContent=t; modalLow.appendChild(li);
  });

  modalBack.style.display = "flex";
}
function closeModal(){ modalBack.style.display="none"; }
modalClose.onclick = closeModal;
modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

/** =========================
 *  5) CSV (UTF-8 BOM чтобы Excel не ломал кириллицу)
 *  ========================= */
function downloadCSV(){
  if(!lastReport.length){
    alert("Сначала нажми «Проверить».");
    return;
  }
  const header = ["Показатель","Значение","Ед.","Норма","Статус"];
  const lines = [header.join(";")].concat(
    lastReport.map(r => [
      r.name,
      (r.value ?? "").toString().replace(".", ","), // под Excel
      r.unit ?? "",
      r.norm ?? "",
      r.status ?? ""
    ].map(x => String(x).replaceAll(";", ",")).join(";"))
  );

  // BOM + UTF-8
  const csv = "\ufeff" + lines.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "labs_report.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** =========================
 *  6) Demo / Clear
 *  ========================= */
function demoFill(){
  ageYearsEl.value = "2";
  sexEl.value = "any";
  updateNormsPreview();

  const sample = {
    "Лейкоциты (WBC)": "6,1",
    "Эритроциты (RBC)": "4,6",
    "Гемоглобин (HGB)": "112",
    "Гематокрит (HCT)": "34",
    "Тромбоциты (PLT)": "420",
    "СОЭ": "6",
    "RDW-CV": "13",
    "MCHC": "330"
  };
  document.querySelectorAll("input[data-key]").forEach(inp=>{
    const key = inp.getAttribute("data-key");
    inp.value = sample[key] ?? "";
  });
}
function clearAll(){
  document.querySelectorAll("input[data-key]").forEach(inp=>inp.value="");
  lastReport = [];
  updateNormsPreview();
  // сброс статусов
  fields.forEach(f=>{
    const statusCell = document.querySelector(`[data-status="${CSS.escape(f.key)}"]`);
    if(statusCell) statusCell.innerHTML = `<span class="badge muted">—</span>`;
  });
}

/** =========================
 *  INIT
 *  ========================= */
buildTable();
updateNormsPreview();

document.getElementById("btnCheck").onclick = () => { updateNormsPreview(); runCheck(); };
document.getElementById("btnDemo").onclick = () => { demoFill(); updateNormsPreview(); runCheck(); };
document.getElementById("btnClear").onclick = clearAll;
document.getElementById("btnCSV").onclick = downloadCSV;

ageYearsEl.addEventListener("input", updateNormsPreview);
sexEl.addEventListener("change", updateNormsPreview);
</script>
</body>
</html>
